---
title: 'Schema API'
description: 'OpenManus 데이터 구조 API 참조'
---

# Schema API 참조

OpenManus의 핵심 데이터 구조와 스키마를 정의합니다.

## Message

에이전트 간 메시지를 표현하는 클래스입니다.

```python
from app.schema import Message
```

### 클래스 정의

```python
class Message(BaseModel):
    """LLM 메시지를 표현하는 클래스"""

    role: str
    content: Union[str, List[dict]]
    name: Optional[str]
    tool_calls: Optional[List["ToolCall"]]
    tool_call_id: Optional[str]
```

### 필드

| 필드 | 타입 | 설명 |
|------|------|------|
| `role` | str | 메시지 역할 (system, user, assistant, tool) |
| `content` | Union[str, List[dict]] | 메시지 내용 |
| `name` | Optional[str] | 발신자 이름 |
| `tool_calls` | Optional[List[ToolCall]] | 도구 호출 목록 |
| `tool_call_id` | Optional[str] | 도구 호출 ID (도구 응답용) |

### 클래스 메서드

#### system_message

```python
@classmethod
def system_message(cls, content: str) -> "Message":
    """
    시스템 메시지 생성

    Parameters:
        content: 시스템 메시지 내용

    Returns:
        role이 "system"인 Message 인스턴스

    예제:
        msg = Message.system_message("당신은 도움이 되는 AI 어시스턴트입니다.")
    """
```

#### user_message

```python
@classmethod
def user_message(
    cls,
    content: Union[str, List[dict]],
    name: Optional[str] = None
) -> "Message":
    """
    사용자 메시지 생성

    Parameters:
        content: 사용자 메시지 내용
        name: 사용자 이름 (선택사항)

    Returns:
        role이 "user"인 Message 인스턴스

    예제:
        msg = Message.user_message("안녕하세요")
        msg_with_name = Message.user_message("안녕하세요", name="Alice")
    """
```

#### assistant_message

```python
@classmethod
def assistant_message(
    cls,
    content: Optional[str] = None,
    tool_calls: Optional[List["ToolCall"]] = None,
    name: Optional[str] = None
) -> "Message":
    """
    어시스턴트 메시지 생성

    Parameters:
        content: 어시스턴트 응답 내용
        tool_calls: 도구 호출 목록
        name: 어시스턴트 이름 (선택사항)

    Returns:
        role이 "assistant"인 Message 인스턴스

    예제:
        msg = Message.assistant_message("도움이 될까요?")
        msg_with_tools = Message.assistant_message(
            tool_calls=[tool_call]
        )
    """
```

#### tool_message

```python
@classmethod
def tool_message(
    cls,
    content: str,
    tool_call_id: str,
    name: Optional[str] = None
) -> "Message":
    """
    도구 응답 메시지 생성

    Parameters:
        content: 도구 실행 결과
        tool_call_id: 관련된 도구 호출 ID
        name: 도구 이름 (선택사항)

    Returns:
        role이 "tool"인 Message 인스턴스

    예제:
        msg = Message.tool_message(
            content="계산 결과: 42",
            tool_call_id="call_123"
        )
    """
```

### 인스턴스 메서드

#### to_dict

```python
def to_dict(self) -> dict:
    """
    메시지를 딕셔너리로 변환

    Returns:
        LLM API 호출에 사용할 수 있는 딕셔너리

    예제:
        msg = Message.user_message("안녕")
        msg_dict = msg.to_dict()
        # {"role": "user", "content": "안녕"}
    """
```

### 사용 예제

```python
from app.schema import Message

# 다양한 메시지 생성
system_msg = Message.system_message("당신은 Python 전문가입니다.")
user_msg = Message.user_message("Python에서 리스트를 정렬하는 방법은?")
assistant_msg = Message.assistant_message("sorted() 함수를 사용하세요.")

# LLM에 전송할 메시지 리스트
messages = [
    system_msg.to_dict(),
    user_msg.to_dict(),
    assistant_msg.to_dict()
]
```

---

## Function

도구 호출의 함수 정보를 표현하는 클래스입니다.

```python
from app.schema import Function
```

### 클래스 정의

```python
class Function(BaseModel):
    """도구 호출의 함수 정보"""

    name: str
    arguments: Union[str, dict]
```

### 필드

| 필드 | 타입 | 설명 |
|------|------|------|
| `name` | str | 함수 이름 |
| `arguments` | Union[str, dict] | 함수 인자 (JSON 문자열 또는 딕셔너리) |

### 사용 예제

```python
from app.schema import Function

# 딕셔너리로 생성
func = Function(
    name="calculate",
    arguments={"operation": "add", "a": 5, "b": 3}
)

# JSON 문자열로 생성
func = Function(
    name="search",
    arguments='{"query": "Python tutorial"}'
)
```

---

## ToolCall

도구 호출을 표현하는 클래스입니다.

```python
from app.schema import ToolCall
```

### 클래스 정의

```python
class ToolCall(BaseModel):
    """도구 호출 정보"""

    id: str
    type: str
    function: Function
```

### 필드

| 필드 | 타입 | 설명 |
|------|------|------|
| `id` | str | 도구 호출 고유 ID |
| `type` | str | 호출 유형 (일반적으로 "function") |
| `function` | Function | 함수 정보 |

### 사용 예제

```python
from app.schema import ToolCall, Function

# 도구 호출 생성
tool_call = ToolCall(
    id="call_abc123",
    type="function",
    function=Function(
        name="python_execute",
        arguments={"code": "print('Hello')"}
    )
)

# 어시스턴트 메시지에 포함
from app.schema import Message

assistant_msg = Message.assistant_message(
    content=None,
    tool_calls=[tool_call]
)
```

---

## ToolChoice

LLM의 도구 사용 방식을 제어하는 열거형입니다.

```python
from app.schema import ToolChoice
```

### 값

```python
class ToolChoice(str, Enum):
    """도구 선택 방식"""

    AUTO = "auto"        # LLM이 자동으로 결정
    NONE = "none"        # 도구 사용 안 함
    REQUIRED = "required"  # 반드시 도구 사용
```

### 사용 예제

```python
from app.schema import ToolChoice
from app.llm import LLM

llm = LLM()

# 자동 도구 선택
response = await llm.ask_tool(
    messages=messages,
    tools=tools,
    tool_choice=ToolChoice.AUTO
)

# 도구 사용 필수
response = await llm.ask_tool(
    messages=messages,
    tools=tools,
    tool_choice=ToolChoice.REQUIRED
)

# 도구 사용 금지
response = await llm.ask(
    messages=messages,
    tool_choice=ToolChoice.NONE
)
```

---

## AgentState

에이전트의 현재 상태를 나타내는 열거형입니다.

```python
from app.schema import AgentState
```

### 값

```python
class AgentState(str, Enum):
    """에이전트 상태"""

    IDLE = "idle"          # 대기 중
    RUNNING = "running"    # 실행 중
    FINISHED = "finished"  # 완료
    ERROR = "error"        # 오류 발생
```

### 사용 예제

```python
from app.schema import AgentState
from app.agent.base import BaseAgent

class MyAgent(BaseAgent):
    async def run(self, request: str) -> str:
        # 실행 중으로 상태 변경
        self.state = AgentState.RUNNING

        try:
            # 작업 수행
            result = await self.process(request)

            # 완료 상태로 변경
            self.state = AgentState.FINISHED
            return result

        except Exception as e:
            # 오류 상태로 변경
            self.state = AgentState.ERROR
            raise
```

---

## Memory

에이전트의 메시지 이력을 관리하는 클래스입니다.

```python
from app.schema import Memory
```

### 클래스 정의

```python
class Memory(BaseModel):
    """에이전트 메모리 (메시지 이력)"""

    messages: List[Message]
    max_messages: int
```

### 필드

| 필드 | 타입 | 기본값 | 설명 |
|------|------|--------|------|
| `messages` | List[Message] | [] | 메시지 목록 |
| `max_messages` | int | 100 | 최대 메시지 수 |

### 메서드

#### add

```python
def add(self, message: Message) -> None:
    """
    메시지 추가

    Parameters:
        message: 추가할 메시지

    max_messages를 초과하면 가장 오래된 메시지 제거
    """
```

#### add_many

```python
def add_many(self, messages: List[Message]) -> None:
    """
    여러 메시지 일괄 추가

    Parameters:
        messages: 추가할 메시지 리스트
    """
```

#### get_messages

```python
def get_messages(self, limit: Optional[int] = None) -> List[Message]:
    """
    메시지 조회

    Parameters:
        limit: 반환할 최대 메시지 수 (None이면 전체)

    Returns:
        메시지 리스트 (최신순)
    """
```

#### clear

```python
def clear(self) -> None:
    """
    모든 메시지 삭제
    """
```

#### to_dict_list

```python
def to_dict_list(self) -> List[dict]:
    """
    모든 메시지를 딕셔너리 리스트로 변환

    Returns:
        LLM API 호출에 사용할 수 있는 딕셔너리 리스트
    """
```

### 사용 예제

```python
from app.schema import Memory, Message

# 메모리 생성
memory = Memory(max_messages=50)

# 메시지 추가
memory.add(Message.user_message("안녕하세요"))
memory.add(Message.assistant_message("안녕하세요! 무엇을 도와드릴까요?"))

# 메시지 조회
recent_messages = memory.get_messages(limit=10)

# LLM 호출용 변환
messages_dict = memory.to_dict_list()

# 메모리 초기화
memory.clear()
```

---

## ToolResult

도구 실행 결과를 표현하는 클래스입니다.

```python
from app.schema import ToolResult
```

### 클래스 정의

```python
class ToolResult(BaseModel):
    """도구 실행 결과"""

    output: str
    is_error: bool
    error_message: Optional[str]
```

### 필드

| 필드 | 타입 | 기본값 | 설명 |
|------|------|--------|------|
| `output` | str | - | 도구 실행 결과 |
| `is_error` | bool | False | 오류 발생 여부 |
| `error_message` | Optional[str] | None | 오류 메시지 |

### 사용 예제

```python
from app.schema import ToolResult

# 성공 결과
success_result = ToolResult(
    output="계산 완료: 42",
    is_error=False
)

# 오류 결과
error_result = ToolResult(
    output="",
    is_error=True,
    error_message="Division by zero"
)

# 결과 확인
if result.is_error:
    print(f"오류: {result.error_message}")
else:
    print(f"결과: {result.output}")
```

---

## 종합 사용 예제

### 에이전트와 메모리

```python
from app.schema import Memory, Message, AgentState
from app.agent.base import BaseAgent

class SimpleAgent(BaseAgent):
    def __init__(self, **data):
        super().__init__(**data)
        self.memory = Memory(max_messages=100)
        self.state = AgentState.IDLE

    async def run(self, request: str) -> str:
        self.state = AgentState.RUNNING

        # 사용자 메시지 저장
        self.memory.add(Message.user_message(request))

        # 처리
        response = await self.process(request)

        # 응답 저장
        self.memory.add(Message.assistant_message(response))

        self.state = AgentState.FINISHED
        return response
```

### 도구 호출 흐름

```python
from app.schema import Message, ToolCall, Function, ToolResult

# 1. LLM이 도구 호출 요청
tool_call = ToolCall(
    id="call_123",
    type="function",
    function=Function(
        name="search_web",
        arguments={"query": "Python tutorial"}
    )
)

# 2. 어시스턴트 메시지에 도구 호출 포함
assistant_msg = Message.assistant_message(
    tool_calls=[tool_call]
)

# 3. 도구 실행
from app.tool import WebSearch

tool = WebSearch()
result = await tool.execute(query="Python tutorial")

# 4. 도구 결과를 메시지로 변환
tool_msg = Message.tool_message(
    content=result.output,
    tool_call_id=tool_call.id,
    name="search_web"
)

# 5. 메시지 이력에 추가
memory.add(assistant_msg)
memory.add(tool_msg)
```

### 대화 흐름

```python
from app.schema import Memory, Message
from app.llm import LLM

# 초기화
memory = Memory(max_messages=50)
llm = LLM()

# 시스템 프롬프트 설정
system_msg = Message.system_message(
    "당신은 Python 프로그래밍 전문가입니다."
)

# 사용자 질문
user_msg = Message.user_message(
    "리스트 컴프리헨션을 설명해주세요."
)

# 메모리에 추가
memory.add(user_msg)

# LLM 호출
response = await llm.ask(
    messages=memory.to_dict_list(),
    system_msgs=[system_msg]
)

# 응답 저장
assistant_msg = Message.assistant_message(response)
memory.add(assistant_msg)

# 대화 이력 조회
conversation = memory.get_messages()
for msg in conversation:
    print(f"{msg.role}: {msg.content}")
```

---

## 모범 사례

### 1. 메모리 관리

```python
from app.schema import Memory, Message

# ✅ 좋은 예: 적절한 최대 메시지 수 설정
memory = Memory(max_messages=50)

# ✅ 중요한 메시지는 따로 저장
important_messages = []

user_msg = Message.user_message("중요한 정보")
memory.add(user_msg)
important_messages.append(user_msg)

# ✅ 주기적으로 오래된 메시지 정리
if len(memory.messages) > 40:
    # 중요 메시지만 유지
    memory.messages = important_messages + memory.get_messages(limit=10)
```

### 2. 상태 관리

```python
from app.schema import AgentState

class StatefulAgent(BaseAgent):
    async def run(self, request: str) -> str:
        # ✅ 상태 전환 명확히
        self.state = AgentState.RUNNING

        try:
            result = await self.process(request)
            self.state = AgentState.FINISHED
            return result

        except Exception as e:
            # ✅ 오류 시 상태 업데이트
            self.state = AgentState.ERROR
            raise

        finally:
            # ✅ 정리 작업
            if self.state != AgentState.ERROR:
                self.state = AgentState.IDLE
```

### 3. 도구 결과 처리

```python
from app.schema import ToolResult

async def safe_tool_execution(tool, **kwargs):
    """안전한 도구 실행"""
    try:
        result = await tool.execute(**kwargs)

        # ✅ 결과 검증
        if result.is_error:
            print(f"도구 오류: {result.error_message}")
            return None

        return result.output

    except Exception as e:
        # ✅ 예외를 ToolResult로 변환
        return ToolResult(
            output="",
            is_error=True,
            error_message=str(e)
        )
```

---

## 참고

- 관련 문서: [Memory 개념](/docs/concepts/memory)
- 에이전트 API: [Agents API](/docs/api/agents)
- 도구 API: [Tools API](/docs/api/tools)
