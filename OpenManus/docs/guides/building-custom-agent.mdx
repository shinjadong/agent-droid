# 커스텀 에이전트 만들기 (Building Custom Agents)

이 가이드에서는 특정 목적에 맞는 커스텀 AI 에이전트를 만드는 방법을 설명합니다.

## 왜 커스텀 에이전트인가?

기본 Manus 에이전트는 범용적이지만, 다음과 같은 경우 커스텀 에이전트가 필요할 수 있습니다:

- **특화된 도구 세트**: 특정 작업에 필요한 도구만 포함
- **커스텀 프롬프트**: 특정 역할이나 스타일로 동작
- **도메인 지식**: 전문 분야의 지식을 내장
- **워크플로우 최적화**: 반복적인 작업 패턴 자동화

## 기본 커스텀 에이전트

### 1단계: BaseAgent 상속

```python
from app.agent.base import BaseAgent
from app.schema import Message
from typing import Optional

class MyCustomAgent(BaseAgent):
    """커스텀 에이전트 예제"""
    
    def __init__(
        self,
        name: str = "CustomAgent",
        **kwargs
    ):
        super().__init__(name=name, **kwargs)
        
        # 커스텀 시스템 프롬프트
        self.system_prompt = """
        당신은 데이터 분석 전문 AI 에이전트입니다.
        Python과 pandas를 사용하여 데이터를 분석하고,
        명확한 인사이트를 제공합니다.
        """
    
    async def step(self) -> str:
        """단일 실행 단계"""
        # 메시지에 시스템 프롬프트 추가
        messages = [
            Message(role="system", content=self.system_prompt)
        ] + self.memory.get_messages()
        
        # LLM 호출
        response = await self.llm.chat(messages)
        
        # 응답 처리
        self.memory.add_message(
            Message(role="assistant", content=response.content)
        )
        
        return response.content
```

### 2단계: 에이전트 사용

```python
import asyncio

async def main():
    # 커스텀 에이전트 생성
    agent = MyCustomAgent()
    
    try:
        result = await agent.run("""
        sales_data.csv를 분석해서:
        1. 월별 매출 추이
        2. 베스트셀러 제품
        3. 주요 인사이트
        """)
        print(result)
        
    finally:
        await agent.cleanup()

asyncio.run(main())
```

## 특화된 에이전트 예제

### 데이터 분석 에이전트

```python
from app.agent.tool_call import ToolCallAgent
from app.tool.code import PythonExecute
from app.tool.collection import ToolCollection

class DataAnalystAgent(ToolCallAgent):
    """데이터 분석 전문 에이전트"""
    
    @classmethod
    async def create(cls):
        # 샌드박스 매니저 생성
        from app.sandbox import SandboxManager
        sandbox = await SandboxManager.create()
        
        # 데이터 분석 도구 추가
        tools = ToolCollection()
        tools.add_tool(PythonExecute(sandbox_manager=sandbox))
        
        # 시스템 프롬프트
        system_prompt = """
        당신은 숙련된 데이터 분석가입니다.
        
        데이터 분석 프로세스:
        1. 데이터 탐색 (EDA)
        2. 데이터 정제
        3. 통계 분석
        4. 시각화
        5. 인사이트 도출
        
        사용 라이브러리:
        - pandas: 데이터 처리
        - numpy: 수치 계산
        - matplotlib/seaborn: 시각화
        - scipy/statsmodels: 통계 분석
        
        항상 코드와 함께 명확한 설명을 제공하세요.
        """
        
        return cls(
            tools=tools,
            system_prompt=system_prompt,
            name="DataAnalyst"
        )
```

### 웹 스크래핑 에이전트

```python
from app.tool.browser import BrowserUseTool

class WebScraperAgent(ToolCallAgent):
    """웹 스크래핑 전문 에이전트"""
    
    @classmethod
    async def create(cls):
        # 브라우저 도구 추가
        tools = ToolCollection()
        tools.add_tool(BrowserUseTool())
        
        system_prompt = """
        당신은 웹 스크래핑 전문가입니다.
        
        스크래핑 프로세스:
        1. 페이지 로드 및 검증
        2. 데이터 추출
        3. 정제 및 구조화
        4. 저장 (CSV/JSON)
        
        주의사항:
        - robots.txt 확인
        - 요청 간격 조절
        - 오류 처리
        - 데이터 검증
        
        윤리적이고 법적으로 허용된 방식으로만 작업하세요.
        """
        
        return cls(
            tools=tools,
            system_prompt=system_prompt,
            name="WebScraper"
        )
```

### 코드 리뷰 에이전트

```python
from app.tool.editor import StrReplaceEditor

class CodeReviewerAgent(ToolCallAgent):
    """코드 리뷰 전문 에이전트"""
    
    @classmethod
    async def create(cls):
        # 파일 편집 도구 추가
        tools = ToolCollection()
        tools.add_tool(StrReplaceEditor())
        
        system_prompt = """
        당신은 경험 많은 시니어 개발자이자 코드 리뷰어입니다.
        
        리뷰 체크리스트:
        1. 코드 품질
           - 가독성
           - 유지보수성
           - 일관성
        
        2. 모범 사례
           - SOLID 원칙
           - DRY 원칙
           - 디자인 패턴
        
        3. 잠재적 문제
           - 버그
           - 성능 이슈
           - 보안 취약점
        
        4. 테스트
           - 테스트 커버리지
           - 엣지 케이스
        
        건설적인 피드백과 개선 제안을 제공하세요.
        """
        
        return cls(
            tools=tools,
            system_prompt=system_prompt,
            name="CodeReviewer"
        )
```

## 도구 커스터마이징

### 도구 선택적 추가

```python
class SelectiveAgent(ToolCallAgent):
    @classmethod
    async def create(cls, enable_browser=True, enable_python=True):
        tools = ToolCollection()
        
        if enable_python:
            sandbox = await SandboxManager.create()
            tools.add_tool(PythonExecute(sandbox_manager=sandbox))
        
        if enable_browser:
            tools.add_tool(BrowserUseTool())
        
        return cls(tools=tools)
```

### 커스텀 도구 통합

```python
from app.tool.base import BaseTool, ToolResult

class MyCustomTool(BaseTool):
    """커스텀 도구 예제"""
    
    name: str = "my_custom_tool"
    description: str = "내 커스텀 기능 실행"
    parameters: dict = {
        "type": "object",
        "properties": {
            "input": {"type": "string", "description": "입력값"}
        },
        "required": ["input"]
    }
    
    async def execute(self, **kwargs) -> ToolResult:
        input_val = kwargs.get("input")
        
        # 커스텀 로직
        result = f"처리된 결과: {input_val.upper()}"
        
        return ToolResult(
            output=result,
            is_error=False
        )

# 에이전트에 추가
class MyAgent(ToolCallAgent):
    @classmethod
    async def create(cls):
        tools = ToolCollection()
        tools.add_tool(MyCustomTool())
        return cls(tools=tools)
```

## 고급 기능

### 메모리 커스터마이징

```python
class LongMemoryAgent(BaseAgent):
    def __init__(self, **kwargs):
        super().__init__(**kwargs)
        
        # 메모리 크기 증가
        self.memory.max_messages = 100
        
        # 중요 메시지 보존
        self.important_messages = []
    
    def save_important(self, message: Message):
        """중요 메시지 저장"""
        self.important_messages.append(message)
    
    async def step(self) -> str:
        # 중요 메시지를 항상 포함
        messages = self.important_messages + self.memory.get_messages()
        
        response = await self.llm.chat(messages)
        
        # 응답이 중요하면 저장
        if self._is_important(response):
            self.save_important(response)
        
        return response.content
    
    def _is_important(self, message: Message) -> bool:
        # 중요도 판단 로직
        keywords = ["중요", "핵심", "결정"]
        return any(kw in message.content for kw in keywords)
```

### 상태 관리

```python
from enum import Enum

class AgentState(Enum):
    IDLE = "idle"
    PLANNING = "planning"
    EXECUTING = "executing"
    REVIEWING = "reviewing"
    COMPLETED = "completed"

class StatefulAgent(BaseAgent):
    def __init__(self, **kwargs):
        super().__init__(**kwargs)
        self.state = AgentState.IDLE
        self.plan = []
        self.results = {}
    
    async def step(self) -> str:
        if self.state == AgentState.IDLE:
            return await self._start_planning()
        elif self.state == AgentState.PLANNING:
            return await self._create_plan()
        elif self.state == AgentState.EXECUTING:
            return await self._execute_plan()
        elif self.state == AgentState.REVIEWING:
            return await self._review_results()
        
        return "작업 완료"
    
    async def _start_planning(self) -> str:
        self.state = AgentState.PLANNING
        return "계획 수립 시작"
    
    async def _create_plan(self) -> str:
        # 계획 생성 로직
        self.plan = ["단계1", "단계2", "단계3"]
        self.state = AgentState.EXECUTING
        return f"계획 완료: {self.plan}"
    
    async def _execute_plan(self) -> str:
        # 계획 실행 로직
        for step in self.plan:
            result = await self._execute_step(step)
            self.results[step] = result
        
        self.state = AgentState.REVIEWING
        return "실행 완료"
    
    async def _review_results(self) -> str:
        # 결과 검토
        self.state = AgentState.COMPLETED
        return f"검토 완료: {self.results}"
    
    async def _execute_step(self, step: str) -> str:
        # 단계 실행 로직
        return f"{step} 완료"
```

## 모범 사례

### 1. 명확한 역할 정의

```python
# ✅ 좋은 시스템 프롬프트
system_prompt = """
당신은 금융 데이터 분석 전문가입니다.

역할:
- 재무 데이터 분석
- 투자 인사이트 제공
- 리스크 평가

제약사항:
- 투자 조언은 제공하지 않음
- 데이터 기반 분석만 수행
- 불확실성을 명확히 표시

출력 형식:
- 명확한 수치 제시
- 시각화 포함
- 핵심 요약
"""
```

### 2. 오류 처리

```python
class RobustAgent(BaseAgent):
    async def step(self) -> str:
        try:
            return await self._execute()
        except Exception as e:
            self.logger.error(f"에러 발생: {e}")
            
            # 복구 시도
            if self.can_recover(e):
                return await self._recover(e)
            
            # 사용자에게 알림
            return f"작업 실패: {str(e)}"
    
    def can_recover(self, error: Exception) -> bool:
        # 복구 가능한 에러 판단
        return isinstance(error, (TimeoutError, ConnectionError))
    
    async def _recover(self, error: Exception) -> str:
        # 복구 로직
        self.logger.info("복구 시도 중...")
        return await self._execute()
```

### 3. 테스트 가능한 설계

```python
class TestableAgent(BaseAgent):
    def __init__(self, llm=None, **kwargs):
        super().__init__(**kwargs)
        self._llm = llm  # 테스트용 LLM 주입 가능
    
    @property
    def llm(self):
        return self._llm or super().llm

# 테스트
class MockLLM:
    async def chat(self, messages):
        return Message(role="assistant", content="테스트 응답")

async def test_agent():
    agent = TestableAgent(llm=MockLLM())
    result = await agent.run("테스트")
    assert "테스트 응답" in result
```

## 실전 예제

### 리서치 에이전트

```python
class ResearchAgent(ToolCallAgent):
    """웹 리서치 및 보고서 작성 에이전트"""
    
    @classmethod
    async def create(cls):
        tools = ToolCollection()
        tools.add_tool(BrowserUseTool())
        tools.add_tool(WebSearch())
        tools.add_tool(StrReplaceEditor())
        
        system_prompt = """
        당신은 철저한 리서치 전문가입니다.
        
        리서치 프로세스:
        1. 주제 분석 및 키워드 추출
        2. 다양한 소스에서 정보 수집
        3. 정보 검증 및 교차 확인
        4. 구조화된 보고서 작성
        
        보고서 구조:
        - 요약 (Executive Summary)
        - 배경 및 맥락
        - 주요 발견사항
        - 분석 및 인사이트
        - 결론 및 제언
        - 참고 자료
        
        모든 주장은 출처를 명시하세요.
        """
        
        return cls(tools=tools, system_prompt=system_prompt)

# 사용 예제
async def research_example():
    agent = await ResearchAgent.create()
    
    result = await agent.run("""
    'AI 에이전트 프레임워크' 주제로 리서치하고
    10페이지 분량의 보고서를 작성해줘.
    
    포함 내용:
    - 주요 프레임워크 비교
    - 기술 동향
    - 시장 전망
    - 모범 사례
    """)
    
    print(result)
```

## 다음 단계

- [멀티 에이전트 워크플로우](./multi-agent-workflows.mdx) - 여러 에이전트 협업
- [커스텀 도구 개발](./developing-tools.mdx) - 새로운 도구 만들기
- [에이전트 개념](../concepts/agents.mdx) - 에이전트 아키텍처 이해
